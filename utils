
// utils/index.js
import 'dotenv/config';
import twilio from 'twilio';
import { DateTime } from 'luxon';

export const twilioClient = twilio(
  process.env.TWILIO_ACCOUNT_SID,
  process.env.TWILIO_AUTH_TOKEN
);

// ----- Rate limiting -----

const rateLimitWindowMs = 60_000; // 1 minute
const rateLimitMaxMessages = 10;
const rateLimitMap = new Map();

export function isRateLimited(phone) {
  if (!phone) return false;

  const now = Date.now();
  const existing = rateLimitMap.get(phone);

  if (!existing || now - existing.start > rateLimitWindowMs) {
    rateLimitMap.set(phone, { start: now, count: 1 });
    return false;
  }

  existing.count += 1;
  if (existing.count > rateLimitMaxMessages) {
    return true;
  }

  return false;
}

// ----- Owner alerts -----

export async function notifyOwnerAlert(message) {
  const ownerPhone = process.env.ALERT_PHONE_E164;
  if (!ownerPhone) return;

  try {
    await twilioClient.messages.create({
      from: process.env.TWILIO_PHONE_NUMBER,
      to: ownerPhone,
      body: `[OpenYard Alert] ${message}`,
    });
  } catch (err) {
    console.error('Error sending owner alert:', err);
  }
}

// ----- Pricing -----

export function computePricing(lot, stayType, nights) {
  const n = Number(nights || 1);
  const nightly = lot.nightly_rate_cents || 2500;

  let subtotal = nightly * n;

  if (stayType === 'weekly' && lot.weekly_rate_cents) {
    subtotal = lot.weekly_rate_cents;
  }
  if (stayType === 'monthly' && lot.monthly_rate_cents) {
    subtotal = lot.monthly_rate_cents;
  }

  const depositHold = 0;
  const total = subtotal + depositHold;

  return {
    nightly_rate_cents: nightly,
    weekly_rate_cents: lot.weekly_rate_cents,
    monthly_rate_cents: lot.monthly_rate_cents,
    subtotal_cents: subtotal,
    deposit_hold_cents: depositHold,
    total_cents: total,
  };
}

// ----- Review send time -----

export function computeReviewSendAt(lot) {
  const lotTz = (lot && lot.time_zone) || 'America/Denver';

  const nowLot = DateTime.now().setZone(lotTz);
  const nextDay8pmLot = nowLot
    .plus({ days: 1 })
    .startOf('day')
    .plus({ hours: 20 });

  return nextDay8pmLot.toUTC().toISO();
}
